<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹ä½æŠ½å–å™¨</title>
    <style>
        /* æ–¹ä½æŠ½å–å™¨æ ·å¼æ–‡ä»¶ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .draw-section {
            margin-bottom: 30px;
        }

        .draw-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin: 10px;
        }

        .draw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .draw-button:active {
            transform: translateY(0);
        }

        .result-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
            border-right: 5px solid #667eea;
        }

        .result-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-label {
            font-weight: bold;
            color: #666;
            min-width: 80px;
            text-align: left;
        }

        .result-value {
            flex: 1;
            text-align: center;
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
        }

        .mode-result {
            color: #e74c3c;
        }

        .direction-result {
            color: #3498db;
        }        .point-result {
            color: #27ae60;
        }

        .redraw-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .redraw-button:hover {
            background: linear-gradient(45deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .copy-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
        }

        .copy-text {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            word-break: break-all;
        }

        .copy-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .copy-button:hover {
            background: white;
            color: #f5576c;
        }

        .copy-success {
            background: #27ae60 !important;
            border-color: #27ae60 !important;
        }

        .rules-section {
            margin-top: 30px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .rules-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: center;
        }

        .rules-content {
            color: #666;
            line-height: 1.6;
        }

        .rules-content ul {
            margin-left: 20px;
        }

        .rules-content li {
            margin: 8px 0;
        }

        /* å†å²è®°å½•å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .history-time {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 5px;
        }

        .history-result {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }        .modal-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* è‡ªå®šä¹‰æ¨¡å¼è¯¦æƒ…å¼¹çª—ç‰¹æ®Šæ ·å¼ */
        .custom-detail-section {
            transition: all 0.3s ease;
        }

        .custom-detail-input, .custom-detail-textarea, .custom-detail-select {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-detail-input:focus, .custom-detail-textarea:focus, .custom-detail-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .custom-mode-item {
            transition: all 0.3s ease;
        }        .custom-mode-item:hover {
            background: rgba(102, 126, 234, 0.1) !important;
            transform: translateY(-1px);
        }

        /* è‡ªå®šä¹‰æ¨¡å¼åŒºåŸŸè¿‡æ¸¡æ•ˆæœ */
        .custom-mode-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .custom-mode-section.hidden {
            opacity: 0;
            max-height: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        /* è®¾ç½®åŒºåŸŸæ ·å¼ */
        .settings-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .settings-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }

        .setting-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            justify-content: center;
        }

        .mode-settings {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
            margin-top: 15px;
        }

        .mode-settings h4 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .mode-item {
            display: flex;
            justify-content: center;
        }

        .setting-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #555;
            user-select: none;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .setting-label:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .setting-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            height: 18px;
            width: 18px;
            background-color: #eee;
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid #ddd;
            flex-shrink: 0;
        }

        .setting-label:hover .checkmark {
            background-color: #ccc;
        }

        .setting-label input:checked ~ .checkmark {
            background-color: #667eea;
            border-color: #667eea;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .setting-label input:checked ~ .checkmark:after {
            display: block;
        }

        .setting-label .checkmark:after {
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .test-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }        .test-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* è‡ªå®šä¹‰æ¨¡å¼æ ·å¼ */
        .custom-mode-controls input {
            transition: border-color 0.3s ease;
        }

        .custom-mode-controls input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .custom-mode-controls button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .custom-mode-item {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .draw-button {
                padding: 12px 24px;
                font-size: 1rem;
            }

            .result-item {
                flex-direction: column;
                text-align: center;
            }

            .result-label {
                margin-bottom: 5px;
                text-align: center;
            }

            /* æ‰‹æœºç«¯æŠ½å–è®¾ç½®ä¸€è¡Œæ˜¾ç¤º */
            .setting-row {
                flex-direction: row;
                gap: 20px;
                align-items: center;
                justify-content: center;
            }
            
            /* æ‰‹æœºç«¯æ¨¡å¼é€‰æ‹©ä¸€è¡Œæ˜¾ç¤º3ä¸ª */
            .mode-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                max-width: 100%;
            }
            
            /* æ‰‹æœºç«¯ç¼©å°å‹¾é€‰æ¡†å’Œæ–‡å­— */
            .setting-label {
                font-size: 0.8rem;
                padding: 3px 6px;
            }
            
            .checkmark {
                height: 14px;
                width: 14px;
                margin-right: 6px;
                border-width: 1px;
            }
            
            .setting-label .checkmark:after {
                left: 4px;
                top: 1px;
                width: 3px;
                height: 6px;
                border-width: 0 1.5px 1.5px 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .draw-button {
                width: 100%;
                margin: 5px 0;
            }
            
            .copy-text {
                font-size: 1rem;
            }

            .result-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 0;
            margin: 20px 0;
            border-left: none;
            border-right: none;
            }

            .redraw-button {
            margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ–¹ä½æŠ½å–å™¨</h1>
        
        <!-- è®¾ç½®é€‰é¡¹åŒºåŸŸ -->
        <div class="settings-section">
            <h3>æŠ½å–è®¾ç½®</h3>
            <div class="setting-row">                <div class="setting-item">
                    <label class="setting-label">
                        <input type="checkbox" id="enableMode">
                        <span class="checkmark"></span>
                        å¯ç”¨æ¨¡å¼æŠ½å–
                    </label>
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <input type="checkbox" id="enablePoint" checked>
                        <span class="checkmark"></span>
                        å¯ç”¨ç‚¹ä½æŠ½å–
                    </label>
                </div>
            </div>
            
            <!-- æ¨¡å¼è¯¦ç»†è®¾ç½® -->
            <div class="mode-settings" id="modeSettings">
                <h4>æ¨¡å¼é€‰æ‹©</h4>
                <div class="mode-grid">                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeClone" checked>
                            <span class="checkmark"></span>
                            å…‹éš†
                        </label>
                    </div>
                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeSwap" checked>
                            <span class="checkmark"></span>
                            äº¤æ¢
                        </label>
                    </div>
                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeSurprise" checked>
                            <span class="checkmark"></span>
                            æƒŠå–œ
                        </label>
                    </div>
                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeAudience" checked>
                            <span class="checkmark"></span>
                            è§‚ä¼—
                        </label>
                    </div>    
                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeJushi" checked>
                            <span class="checkmark"></span>
                            å·¨å²
                        </label>
                    </div>                                    
                    <div class="mode-item">
                        <label class="setting-label">
                            <input type="checkbox" id="modeNormal" checked>
                            <span class="checkmark"></span>
                            æ™®é€š
                        </label>
                    </div>

                </div>
            </div>            <!-- è‡ªå®šä¹‰æ¨¡å¼åŒºåŸŸ -->
            <div class="custom-mode-section" style="border-top: 1px solid #e9ecef; padding-top: 15px; margin-top: 15px;">
                <h4 style="color: #555; margin-bottom: 15px; font-size: 1rem; text-align: center;">ğŸ¨ è‡ªå®šä¹‰æ¨¡å¼</h4>
                <div class="custom-mode-controls" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                    <input type="text" id="customModeName" placeholder="æ¨¡å¼åç§°" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; max-width: 120px;">
                    <button onclick="showCustomModeDetail()" style="padding: 5px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">è¯¦æƒ…è®¾ç½®</button>
                    <button onclick="addCustomMode()" style="padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">æ·»åŠ æ¨¡å¼</button>
                </div>
                <div id="customModesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 5px; max-width: 500px; margin: 0 auto;">
                    <!-- è‡ªå®šä¹‰æ¨¡å¼åˆ—è¡¨ -->
                </div>
            </div>
            
            <!-- <!== æµ‹è¯•åŠŸèƒ½åŒºåŸŸ ==>
            <div class="test-section" style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                <h4 style="margin-bottom: 10px;">ğŸ“Š æµ‹è¯•åŠŸèƒ½</h4>
                <button class="test-button" onclick="runModeTest()">
                    æµ‹è¯•æ¨¡å¼åˆ†å¸ƒ (100æ¬¡)
                </button>
                <div id="testResults" style="margin-top: 10px; font-size: 12px; color: #666; display: none;"></div>
            </div>
        </div> -->        <div class="draw-section">
            <button class="draw-button" onclick="drawAll()">ğŸ²å¼€å§‹æŠ½å–</button>
        </div>        <div class="result-container" id="resultContainer">
            <div class="result-item" id="modeResultItem">
                <div class="result-label">æ¨¡å¼:</div>
                <div class="result-value mode-result" id="modeResult">-</div>
                <button class="redraw-button" id="drawModeBtn" onclick="drawMode()" style="display: none;">ğŸ”„</button>
            </div>
            <div class="result-item">
                <div class="result-label">ç±»å‹æ–¹ä½:</div>
                <div class="result-value direction-result" id="directionResult">-</div>
                <button class="redraw-button" id="drawDirectionBtn" onclick="drawDirection()">ğŸ”„</button>
            </div>
            <div class="result-item" id="pointResultItem">
                <div class="result-label">ç‚¹ä½:</div>
                <div class="result-value point-result" id="pointResult">-</div>
                <button class="redraw-button" id="drawPointBtn" onclick="drawPoint()" style="display: none;">ğŸ”„</button>
            </div>
        </div>

        <div class="copy-section" id="copySection" style="display: none;">
            <div class="copy-text" id="copyText">-</div>
            <button class="copy-button" id="copyButton" onclick="copyResult()">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        </div>

        <div class="rules-section">
            <div class="rules-title">ğŸ“– æŠ½å–è§„åˆ™è¯´æ˜</div>
            <div class="rules-content">              
                 <p><strong>æ¨¡å¼ç±»å‹ï¼š</strong></p>
                <ul>                    <li><strong>å…‹éš†ï¼š</strong>éšæœºé€‰æ‹©ä¸€ä¸ªç©å®¶ä½œä¸ºå…‹éš†å¯¹è±¡</li>
                    <li><strong>äº¤æ¢ï¼š</strong>éšæœºæŠ½å–äº¤æ¢å…³ç³»ï¼Œæ­¤å¤–æœ‰<math><mfrac><mn>6859</mn><mn>40000</mn></mfrac></math>çš„æ¦‚ç‡æŠ½åˆ°ä¸€ä½ä»»é€‰äº¤æ¢</li>
                    <li><strong>æƒŠå–œï¼š</strong>éšæœºç¦ç”¨æŸä¸ªæŠ€èƒ½æˆ–è£…å¤‡</li>
                    <li><strong>è§‚ä¼—ï¼š</strong>éšæœºå°†ç©å®¶åˆ†é…åˆ°è§‚ä¼—æˆ–å‚æˆ˜ç»„</li>
                    <li><strong>å·¨å²ï¼š</strong>ä»7ä¸ªå…ƒç´ ï¼ˆå†°ç«æ°´é›·å²©é£è‰ï¼‰ä¸­éšæœºé€‰æ‹©3ä¸ª</li>
                    <li><strong>æ™®é€šï¼š</strong>æ— ç‰¹æ®Šé™„åŠ å†…å®¹çš„æ¨¡å¼</li>
                    <li><strong>è‡ªå®šä¹‰ï¼š</strong>ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ¨¡å¼å’Œæè¿°</li>
                </ul>
                <p><strong>ç±»å‹æ–¹ä½ï¼š</strong></p>
                <ul>
                    <li><strong>ç±»å‹ï¼š</strong>ç­‰çº§ã€å‘½åº§ã€æ”»å‡»ã€ç”Ÿå‘½ã€é˜²å¾¡ã€ç²¾é€š</li>
                    <li><strong>æ–¹ä½ï¼š</strong>ä¸Šã€ä¸‹ã€å·¦ã€å³ã€å·¦ä¸Šã€å·¦ä¸‹ã€å³ä¸Šã€å³ä¸‹</li>
                </ul>
                <p><strong>ç‚¹ä½ï¼š</strong>1-6ç‚¹éšæœº</p>
                <p><strong>å¿«æ·é”®ï¼š</strong>Ctrl+Enter(å…¨éƒ¨æŠ½å–) / Ctrl+C(å¤åˆ¶ç»“æœ)</p>
            </div>
        </div>        <!-- å†å²è®°å½•å¼¹çª— -->
        <div class="modal-overlay" id="historyModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“š å†å²è®°å½•</h3>
                    <button class="modal-close" onclick="hideHistory()">âœ•</button>
                </div>
                <div class="modal-body" id="historyContent">
                    <p style="text-align: center; color: #999;">æš‚æ— å†å²è®°å½•</p>
                </div>
                <div class="modal-footer">
                    <button class="modal-button" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰æ¨¡å¼è¯¦æƒ…å¼¹çª— -->
        <div class="modal-overlay" id="customDetailModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ”§ è‡ªå®šä¹‰æ¨¡å¼è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="hideCustomDetail()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">æ¨¡å¼ç±»å‹ï¼š</label>
                        <select id="customModeType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="text">å›ºå®šæ–‡æœ¬</option>
                            <option value="random">éšæœºæŠ½å–</option>
                        </select>
                    </div>
                    
                    <div id="textDetailSection" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">å›ºå®šæ–‡æœ¬ï¼š</label>
                        <input type="text" id="customModeText" placeholder="è¾“å…¥å›ºå®šçš„æ¨¡å¼æè¿°" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    
                    <div id="randomDetailSection" style="display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">æŠ½å–å…ƒç´ ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                        <textarea id="customModeElements" placeholder="è¾“å…¥å¯æŠ½å–çš„å…ƒç´ ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;å…ƒç´ A&#10;å…ƒç´ B&#10;å…ƒç´ C" style="width: 100%; height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                        <small style="color: #666; font-size: 12px;">æ¯æ¬¡æŠ½å–æ—¶ä¼šä»è¿™äº›å…ƒç´ ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-button" onclick="clearCustomDetail()">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <button class="modal-button" onclick="hideCustomDetail()">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ–¹ä½æŠ½å–å™¨å¢å¼ºåŠŸèƒ½
        class FangweiDrawer {            constructor() {
                this.modes = {
                    clone: { name: 'å…‹éš†', enabled: true },
                    swap: { name: 'äº¤æ¢', enabled: true },
                    surprise: { name: 'æƒŠå–œ', enabled: true },
                    audience: { name: 'è§‚ä¼—', enabled: true },
                    normal: { name: 'æ™®é€š', enabled: true },
                    jushi: { name: 'å·¨å²', enabled: true }
                };
                this.types = ['ç­‰çº§', 'å‘½åº§', 'æ”»å‡»', 'ç”Ÿå‘½', 'é˜²å¾¡', 'ç²¾é€š'];
                this.directions = ['ä¸Š', 'ä¸‹', 'å·¦', 'å³', 'å·¦ä¸Š', 'å·¦ä¸‹', 'å³ä¸Š', 'å³ä¸‹'];
                this.points = ['1', '2', '3', '4', '5', '6'];
                this.players = ['1P', '2P', '3P', '4P'];
                this.surpriseItems = ['ç¦A', 'ç¦E', 'ç¦Q', 'ç¦äº”æ˜Ÿæ­¦å™¨'];
                this.elements = ['å†°', 'ç«', 'æ°´', 'é›·', 'å²©', 'é£', 'è‰'];                // è‡ªå®šä¹‰æ¨¡å¼
                this.customModes = [];
                
                // å½“å‰ç¼–è¾‘çš„è‡ªå®šä¹‰æ¨¡å¼è¯¦æƒ…
                this.currentCustomDetail = {
                    type: 'text', // 'text' æˆ– 'random'
                    text: '',
                    elements: []
                };
                
                // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡å¼ï¼ˆç”¨äºåŒºåˆ†æ–°å»ºå’Œç¼–è¾‘ï¼‰
                this.currentEditingMode = null;
                
                this.currentResults = {
                    mode: '',
                    modeDetail: '',
                    direction: '',
                    point: ''
                };
                  // è®¾ç½®é€‰é¡¹
                this.settings = {
                    enableMode: false,
                    enablePoint: true,
                    modes: {
                        clone: true,
                        swap: true, 
                        surprise: true,
                        audience: true,
                        normal: true,
                        jushi: true
                    }
                };
                
                this.history = [];
                this.maxHistory = 10;
                
                this.init();
            }            init() {
                this.loadHistory();
                this.loadCustomModes();
                this.loadSettings();
                this.setupEventListeners();
                this.updateCustomModesList();
                // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºç»“æœå®¹å™¨ï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
                this.showResults();
            }

            randomChoice(array) {
                if (array.length === 0) return null;
                return array[Math.floor(Math.random() * array.length)];
            }
            
            // å¢å¼ºçš„éšæœºé€‰æ‹©ï¼Œå¯ä»¥å¸¦æƒé‡
            weightedRandomChoice(items, weights = null) {
                if (items.length === 0) return null;
                
                if (!weights || weights.length !== items.length) {
                    // å¦‚æœæ²¡æœ‰æƒé‡æˆ–æƒé‡é•¿åº¦ä¸åŒ¹é…ï¼Œä½¿ç”¨ç­‰æƒé‡
                    return this.randomChoice(items);
                }
                
                const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                let random = Math.random() * totalWeight;
                
                for (let i = 0; i < items.length; i++) {
                    if (random < weights[i]) {
                        return items[i];
                    }
                    random -= weights[i];
                }
                
                return items[items.length - 1]; // å¤‡ç”¨è¿”å›
            }

            generateSwapPairs() {
                const RANDOM_SWAP_PROBABILITY = 6859 / 40000;
                
                if (Math.random() < RANDOM_SWAP_PROBABILITY) {
                    const selectedPlayer = this.randomChoice(this.players);
                    return `${selectedPlayer}ä»»é€‰äº¤æ¢`;
                }

                const swapPatterns = [
                    '1Pâ‡„2P 3Pâ‡„4P',
                    '1Pâ‡„3P 2Pâ‡„4P', 
                    '1Pâ‡„4P 2Pâ‡„3P'
                ];
                
                return this.randomChoice(swapPatterns);
            }

            generateAudienceGroups() {
                const audience = [];
                const participants = [];
                
                // æ¯ä¸ªç©å®¶ä¸€ä¸ªä¸€ä¸ªæ‹¿å‡ºæ¥åˆ¤æ–­æ”¾åˆ°å“ªä¸ªç»„ï¼Œæ¦‚ç‡å„50%
                this.players.forEach(player => {
                    if (Math.random() < 0.5) {
                        audience.push(player);
                    } else {
                        participants.push(player);
                    }
                });
                
                // å¤„ç†å…¨éƒ¨åœ¨ä¸€ç»„çš„æƒ…å†µ
                if (audience.length === 0) {
                    return '[å‚æˆ˜ 1P 2P 3P 4P]';
                }
                if (participants.length === 0) {
                    return '[è§‚ä¼— 1P 2P 3P 4P]';
                }
                  // å°Pæ•°çš„ç»„æ”¾åœ¨å‰é¢ï¼ˆäººæ•°å°‘çš„ç»„åœ¨å‰é¢ï¼‰
                if (audience.length <= participants.length) {
                    return `[è§‚ä¼— ${audience.join(' ')}] [å‚æˆ˜ ${participants.join(' ')}]`;
                } else {
                    return `[å‚æˆ˜ ${participants.join(' ')}] [è§‚ä¼— ${audience.join(' ')}]`;
                }
            }
            
            generateJushiElements() {
                // ä»7ä¸ªå…ƒç´ ä¸­éšæœºé€‰æ‹©3ä¸ªï¼ˆä¸æ’åˆ—ï¼‰
                const shuffled = [...this.elements].sort(() => Math.random() - 0.5);
                const selectedElements = shuffled.slice(0, 3);
                return selectedElements.join('');
            }
              drawMode() {
                // è·å–å¯ç”¨çš„æ¨¡å¼
                const enabledModes = Object.keys(this.settings.modes).filter(mode => this.settings.modes[mode]);
                
                if (enabledModes.length === 0) {
                    this.currentResults.mode = '';
                    this.currentResults.modeDetail = '';
                    this.updateModeDisplay();
                    return;
                }
                
                const selectedMode = this.randomChoice(enabledModes);
                  // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰æ¨¡å¼
                const customMode = this.customModes.find(m => m.id === selectedMode);
                if (customMode) {
                    this.currentResults.mode = customMode.name;
                    this.currentResults.modeDetail = this.generateCustomModeDetail(customMode);
                } else {
                    // å¤„ç†å†…ç½®æ¨¡å¼
                    switch (selectedMode) {
                        case 'clone':
                            this.currentResults.mode = 'å…‹éš†';
                            this.currentResults.modeDetail = `å…‹éš† ${this.randomChoice(this.players)}`;
                            break;
                        case 'swap':
                            this.currentResults.mode = 'äº¤æ¢';
                            this.currentResults.modeDetail = this.generateSwapPairs();
                            break;
                        case 'surprise':
                            this.currentResults.mode = 'æƒŠå–œ';
                            this.currentResults.modeDetail = this.randomChoice(this.surpriseItems);
                            break;
                        case 'audience':
                            this.currentResults.mode = 'è§‚ä¼—';
                            this.currentResults.modeDetail = this.generateAudienceGroups();
                            break;
                        case 'normal':
                            this.currentResults.mode = 'æ™®é€š';
                            this.currentResults.modeDetail = '';
                            break;                        case 'jushi':
                            this.currentResults.mode = 'å·¨å²';
                            this.currentResults.modeDetail = this.generateJushiElements();
                            break;
                    }
                }
                
                this.updateModeDisplay();
                this.updateCopyText();
                this.addAnimation('modeResult');
            }
            
            drawDirection() {
                const type = this.randomChoice(this.types);
                const direction = this.randomChoice(this.directions);
                this.currentResults.direction = `${type}${direction}`;
                
                this.updateDirectionDisplay();
                this.updateCopyText();
                this.addAnimation('directionResult');
            }
            
            drawPoint() {
                this.currentResults.point = `${this.randomChoice(this.points)}ç‚¹`;
                
                this.updatePointDisplay();
                this.updateCopyText();
                this.addAnimation('pointResult');
            }
            
            drawAll() {
                // æ ¹æ®è®¾ç½®å†³å®šæŠ½å–å“ªäº›å†…å®¹
                if (this.settings.enableMode) {
                    this.drawMode();
                }
                
                // ç±»å‹æ–¹ä½å§‹ç»ˆæŠ½å–
                this.drawDirection();
                
                if (this.settings.enablePoint) {
                    this.drawPoint();
                }
                
                this.showResults();
                this.addToHistory();
            }
              showResults() {
                // ç»“æœå®¹å™¨å§‹ç»ˆæ˜¾ç¤º
                document.getElementById('resultContainer').style.display = 'block';
                
                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºå†…å®¹
                this.updateModeDisplay();
                this.updateDirectionDisplay();
                this.updatePointDisplay();
                this.updateButtonVisibility();
                
                // åªæœ‰åœ¨æœ‰å®é™…ç»“æœæ—¶æ‰æ˜¾ç¤ºå¤åˆ¶åŒºåŸŸ
                if (this.currentResults.direction || this.currentResults.mode || this.currentResults.point) {
                    document.getElementById('copySection').style.display = 'block';
                } else {
                    document.getElementById('copySection').style.display = 'none';
                }
            }
            
            updateButtonVisibility() {
                // æ¨¡å¼é‡æŠ½æŒ‰é’®ï¼šåªæœ‰åœ¨å¯ç”¨æ¨¡å¼æŠ½å–æ—¶æ‰æ˜¾ç¤º
                const modeBtn = document.getElementById('drawModeBtn');
                if (this.settings.enableMode) {
                    modeBtn.style.display = 'inline-block';
                } else {
                    modeBtn.style.display = 'none';
                }
                
                // ç‚¹ä½é‡æŠ½æŒ‰é’®ï¼šåªæœ‰åœ¨å¯ç”¨ç‚¹ä½æŠ½å–æ—¶æ‰æ˜¾ç¤º
                const pointBtn = document.getElementById('drawPointBtn');
                if (this.settings.enablePoint) {
                    pointBtn.style.display = 'inline-block';
                } else {
                    pointBtn.style.display = 'none';
                }
                
                // æ–¹ä½é‡æŠ½æŒ‰é’®å§‹ç»ˆæ˜¾ç¤ºï¼ˆç±»å‹æ–¹ä½å§‹ç»ˆæŠ½å–ï¼‰
            }            updateModeDisplay() {
                const modeElement = document.getElementById('modeResult');
                if (this.settings.enableMode && this.currentResults.mode) {
                    if (this.currentResults.modeDetail) {
                        // ä½¿ç”¨ "æ¨¡å¼ï¼šè¯¦æƒ…" çš„æ ¼å¼
                        modeElement.textContent = `${this.currentResults.mode}ï¼š${this.currentResults.modeDetail}`;
                    } else {
                        // åªæœ‰æ¨¡å¼å
                        modeElement.textContent = this.currentResults.mode;
                    }
                } else {
                    modeElement.textContent = '-';
                }
            }
            
            updateDirectionDisplay() {
                const directionElement = document.getElementById('directionResult');
                if (this.currentResults.direction) {
                    directionElement.textContent = this.currentResults.direction;
                } else {
                    directionElement.textContent = '-';
                }
            }
            
            updatePointDisplay() {
                const pointElement = document.getElementById('pointResult');
                if (this.settings.enablePoint && this.currentResults.point) {
                    pointElement.textContent = this.currentResults.point;
                } else {
                    pointElement.textContent = '-';
                }
            }

            updateCopyText() {
                // å¿…é¡»æœ‰ç±»å‹æ–¹ä½ï¼Œå…¶ä»–æ ¹æ®è®¾ç½®å†³å®š
                if (this.currentResults.direction) {
                    let copyText = '';
                    
                    // å¦‚æœå¯ç”¨æ¨¡å¼ä¸”æœ‰æ¨¡å¼ç»“æœ
                    if (this.settings.enableMode && this.currentResults.mode) {
                        if (this.currentResults.modeDetail) {
                            // ä½¿ç”¨ "æ¨¡å¼ï¼šè¯¦æƒ…" çš„æ ¼å¼
                            copyText += `${this.currentResults.mode}ï¼š${this.currentResults.modeDetail} `;
                        } else {
                            // åªæœ‰æ¨¡å¼å
                            copyText += this.currentResults.mode + ' ';
                        }
                    }
                    
                    // å§‹ç»ˆåŒ…å«ç±»å‹æ–¹ä½
                    copyText += this.currentResults.direction;
                    
                    // å¦‚æœå¯ç”¨ç‚¹ä½ä¸”æœ‰ç‚¹ä½ç»“æœ
                    if (this.settings.enablePoint && this.currentResults.point) {
                        copyText += ' ' + this.currentResults.point;
                    }
                    
                    document.getElementById('copyText').textContent = copyText;
                }
            }
            
            async copyResult() {
                const copyText = document.getElementById('copyText').textContent;
                const copyButton = document.getElementById('copyButton');
                
                try {
                    await navigator.clipboard.writeText(copyText);
                    this.showCopySuccess(copyButton);
                } catch (err) {
                    this.fallbackCopy(copyText, copyButton);
                }
            }
            
            showCopySuccess(button) {
                const originalText = button.textContent;
                button.textContent = 'âœ… å¤åˆ¶æˆåŠŸ!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copy-success');
                }, 2000);
            }
            
            fallbackCopy(text, button) {
                // é™çº§å¤åˆ¶æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    this.showCopySuccess(button);
                } catch (err) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
                }
                
                document.body.removeChild(textArea);
            }
            
            addAnimation(elementId) {
                const element = document.getElementById(elementId);
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.3s ease';
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }
            
            addToHistory() {
                const copyText = document.getElementById('copyText').textContent;
                if (copyText && copyText !== '-') {
                    const timestamp = new Date().toLocaleString();
                    this.history.unshift({
                        result: copyText,
                        time: timestamp
                    });
                    
                    // é™åˆ¶å†å²è®°å½•æ•°é‡
                    if (this.history.length > this.maxHistory) {
                        this.history = this.history.slice(0, this.maxHistory);
                    }
                    
                    this.saveHistory();
                }
            }
            
            saveHistory() {
                try {
                    localStorage.setItem('fangweiHistory', JSON.stringify(this.history));
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨');
                }
            }
            
            loadHistory() {
                try {
                    const saved = localStorage.getItem('fangweiHistory');
                    if (saved) {
                        this.history = JSON.parse(saved);
                    }
                } catch (e) {
                    console.warn('æ— æ³•åŠ è½½å†å²è®°å½•');
                    this.history = [];
                }
            }
            
            showHistory() {
                const modal = document.getElementById('historyModal');
                const content = document.getElementById('historyContent');
                
                if (this.history.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— å†å²è®°å½•</p>';
                } else {
                    let html = '';
                    this.history.forEach((item, index) => {
                        html += `
                            <div class="history-item">
                                <div class="history-time">${item.time}</div>
                                <div class="history-result">${item.result}</div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                }
                
                modal.style.display = 'flex';
            }
            
            hideHistory() {
                document.getElementById('historyModal').style.display = 'none';
            }
              clearHistory() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                    this.history = [];
                    this.saveHistory();
                    this.showHistory(); // åˆ·æ–°æ˜¾ç¤º
                }
            }
              // è‡ªå®šä¹‰æ¨¡å¼ç®¡ç†
            addCustomMode(name, detailConfig = null) {
                const inputName = name || document.getElementById('customModeName').value;
                if (!inputName || inputName.trim() === '') {
                    alert('è¯·è¾“å…¥æ¨¡å¼åç§°');
                    return;
                }
                
                const id = 'custom_' + Date.now();
                const customMode = {
                    id: id,
                    name: inputName.trim(),
                    detailConfig: detailConfig || { ...this.currentCustomDetail },
                    enabled: true
                };
                
                this.customModes.push(customMode);
                this.settings.modes[id] = true;
                this.saveCustomModes();
                this.saveSettings();
                this.updateCustomModesList();
                this.updateSettingsUI();
                      // æ¸…ç©ºè¾“å…¥
            document.getElementById('customModeName').value = '';
            this.resetCustomDetail();
            }
            
            generateCustomModeDetail(customMode) {
                if (!customMode.detailConfig) return '';
                
                if (customMode.detailConfig.type === 'text') {
                    return customMode.detailConfig.text || '';
                } else if (customMode.detailConfig.type === 'random') {
                    const elements = customMode.detailConfig.elements || [];
                    if (elements.length === 0) return '';
                    return this.randomChoice(elements);
                }
                
                return '';
            }
              removeCustomMode(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰æ¨¡å¼å—ï¼Ÿ')) {
                    this.customModes = this.customModes.filter(m => m.id !== id);
                    delete this.settings.modes[id];
                    this.saveCustomModes();
                    this.saveSettings();
                    this.updateCustomModesList();
                    this.updateSettingsUI();
                }
            }
              editCustomMode(id) {
                const mode = this.customModes.find(m => m.id === id);
                if (mode) {
                    // é€šè¿‡å…¨å±€å‡½æ•°è°ƒç”¨å¼¹çª—
                    window.showCustomModeDetail(mode);
                }
            }
            
            resetCustomDetail() {
                this.currentCustomDetail = {
                    type: 'text',
                    text: '',
                    elements: []
                };
            }
            
            saveCustomModes() {
                try {
                    localStorage.setItem('fangweiCustomModes', JSON.stringify(this.customModes));
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜è‡ªå®šä¹‰æ¨¡å¼åˆ°æœ¬åœ°å­˜å‚¨');
                }
            }
            
            loadCustomModes() {
                try {
                    const saved = localStorage.getItem('fangweiCustomModes');
                    if (saved) {
                        this.customModes = JSON.parse(saved);
                        // å°†è‡ªå®šä¹‰æ¨¡å¼æ·»åŠ åˆ°è®¾ç½®ä¸­
                        this.customModes.forEach(mode => {
                            if (!this.settings.modes.hasOwnProperty(mode.id)) {
                                this.settings.modes[mode.id] = true;
                            }
                        });
                    }
                } catch (e) {
                    console.warn('æ— æ³•åŠ è½½è‡ªå®šä¹‰æ¨¡å¼');
                    this.customModes = [];
                }
            }            updateCustomModesList() {
                const container = document.getElementById('customModesList');
                if (!container) return;
                
                container.innerHTML = '';
                  this.customModes.forEach(mode => {
                    const modeElement = document.createElement('div');
                    modeElement.className = 'custom-mode-item';
                    
                    // æ ¹æ®å¯ç”¨çŠ¶æ€è°ƒæ•´æ ·å¼
                    const isEnabled = this.settings.modes[mode.id] !== false;
                    const opacity = isEnabled ? '1' : '0.5';
                    const borderColor = isEnabled ? 'rgba(102, 126, 234, 0.2)' : 'rgba(128, 128, 128, 0.2)';
                    
                    modeElement.style.cssText = `display: flex; align-items: center; justify-content: space-between; padding: 5px 10px; background: rgba(255,255,255,0.6); border-radius: 5px; margin: 2px 0; border: 1px solid ${borderColor}; opacity: ${opacity}; transition: all 0.2s ease;`;
                    
                    // å·¦ä¾§ï¼šå¯ç”¨/ç¦ç”¨å¤é€‰æ¡†
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.style.cssText = 'margin-right: 8px;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = isEnabled;
                    checkbox.style.cssText = 'cursor: pointer; transform: scale(0.9);';
                    checkbox.onchange = (e) => {
                        this.settings.modes[mode.id] = e.target.checked;
                        this.saveSettings();
                        this.updateCustomModesList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ ·å¼
                    };
                    
                    checkboxContainer.appendChild(checkbox);
                    
                    const modeInfo = document.createElement('div');
                    modeInfo.style.cssText = 'flex: 1; text-align: left; margin-left: 5px;';
                    
                    const modeName = document.createElement('div');
                    modeName.style.cssText = 'font-size: 13px; font-weight: bold; color: #333; margin-bottom: 2px;';
                    modeName.textContent = mode.name;
                    
                    const modeDesc = document.createElement('div');
                    modeDesc.style.cssText = 'font-size: 11px; color: #666;';
                    
                    if (mode.detailConfig) {
                        if (mode.detailConfig.type === 'text') {
                            modeDesc.textContent = mode.detailConfig.text ? `å›ºå®š: ${mode.detailConfig.text}` : 'å›ºå®šæ–‡æœ¬æ¨¡å¼';
                        } else if (mode.detailConfig.type === 'random') {
                            const elemCount = mode.detailConfig.elements ? mode.detailConfig.elements.length : 0;
                            modeDesc.textContent = `éšæœº: ${elemCount}ä¸ªå…ƒç´ `;
                        }
                    } else {
                        modeDesc.textContent = 'æ™®é€šæ¨¡å¼';
                    }
                    
                    modeInfo.appendChild(modeName);
                    modeInfo.appendChild(modeDesc);
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.cssText = 'display: flex; gap: 3px;';
                    
                    const editBtn = document.createElement('button');
                    editBtn.style.cssText = 'background: #ffc107; color: #333; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;';
                    editBtn.textContent = 'âœï¸';
                    editBtn.title = 'ç¼–è¾‘æ¨¡å¼';
                    editBtn.onclick = () => this.editCustomMode(mode.id);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.style.cssText = 'background: #ff4757; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;';
                    removeBtn.textContent = 'Ã—';
                    removeBtn.title = 'åˆ é™¤æ­¤æ¨¡å¼';
                    removeBtn.onclick = () => this.removeCustomMode(mode.id);
                    removeBtn.onmouseover = () => removeBtn.style.background = '#ff3838';
                    removeBtn.onmouseout = () => removeBtn.style.background = '#ff4757';
                    
                    buttonContainer.appendChild(editBtn);
                    buttonContainer.appendChild(removeBtn);
                    
                    modeElement.appendChild(checkboxContainer);
                    modeElement.appendChild(modeInfo);
                    modeElement.appendChild(buttonContainer);
                    container.appendChild(modeElement);
                });
            }
            
            saveSettings() {
                try {
                    localStorage.setItem('fangweiSettings', JSON.stringify(this.settings));
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨');
                }
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem('fangweiSettings');
                    if (saved) {
                        const loadedSettings = JSON.parse(saved);
                        // åˆå¹¶è®¾ç½®ï¼Œç¡®ä¿æ–°å¢çš„è®¾ç½®é¡¹æœ‰é»˜è®¤å€¼
                        this.settings = { ...this.settings, ...loadedSettings };
                        this.settings.modes = { ...this.settings.modes, ...loadedSettings.modes };
                    }
                } catch (e) {
                    console.warn('æ— æ³•åŠ è½½è®¾ç½®');
                }
                
                // æ›´æ–°UI
                this.updateSettingsUI();
            }
            
            updateSettingsUI() {
                // æ›´æ–°ä¸»è¦è®¾ç½®
                document.getElementById('enableMode').checked = this.settings.enableMode;
                document.getElementById('enablePoint').checked = this.settings.enablePoint;
                
                // æ›´æ–°æ¨¡å¼è®¾ç½®
                Object.keys(this.settings.modes).forEach(mode => {
                    const checkbox = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
                    if (checkbox) {
                        checkbox.checked = this.settings.modes[mode];
                    }
                });
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                this.updateDrawButtonsVisibility();
            }            updateDrawButtonsVisibility() {
                const drawModeBtn = document.getElementById('drawModeBtn');
                const drawPointBtn = document.getElementById('drawPointBtn');
                const modeSettings = document.getElementById('modeSettings');
                const customModeSection = document.querySelector('.custom-mode-section');
                
                // è·å–ç»“æœå±•ç¤ºå…ƒç´ 
                const modeResultItem = document.getElementById('modeResultItem');
                const pointResultItem = document.getElementById('pointResultItem');
                  // æ§åˆ¶æ¨¡å¼ç›¸å…³æŒ‰é’®å’Œè®¾ç½®çš„æ˜¾ç¤º
                if (this.settings.enableMode) {
                    drawModeBtn.style.display = 'inline-block';
                    modeSettings.style.display = 'block';
                    if (customModeSection) {
                        customModeSection.style.display = 'block';
                        customModeSection.classList.remove('hidden');
                    }
                    if (modeResultItem) modeResultItem.style.display = 'flex';
                } else {
                    drawModeBtn.style.display = 'none';
                    modeSettings.style.display = 'none';
                    if (customModeSection) {
                        customModeSection.classList.add('hidden');
                        // å»¶è¿Ÿéšè—ï¼Œç­‰å¾…è¿‡æ¸¡åŠ¨ç”»å®Œæˆ
                        setTimeout(() => {
                            if (customModeSection.classList.contains('hidden')) {
                                customModeSection.style.display = 'none';
                            }
                        }, 300);
                    }
                    if (modeResultItem) modeResultItem.style.display = 'none';
                    // æ¸…ç©ºæ¨¡å¼ç»“æœ
                    this.currentResults.mode = '';
                    this.currentResults.modeDetail = '';
                    this.updateModeDisplay();
                }                // æ§åˆ¶ç‚¹ä½æŒ‰é’®çš„æ˜¾ç¤º
                if (this.settings.enablePoint) {
                    drawPointBtn.style.display = 'inline-block';
                    if (pointResultItem) pointResultItem.style.display = 'flex';
                } else {
                    drawPointBtn.style.display = 'none';
                    if (pointResultItem) pointResultItem.style.display = 'none';
                    // æ¸…ç©ºç‚¹ä½ç»“æœ
                    this.currentResults.point = '';
                    this.updatePointDisplay();
                }
                
                // æ›´æ–°å¤åˆ¶æ–‡æœ¬
                this.updateCopyText();
            }
              setupEventListeners() {
                // ä¸»è¦è®¾ç½®ç›‘å¬
                document.getElementById('enableMode').addEventListener('change', (e) => {
                    this.settings.enableMode = e.target.checked;
                    this.saveSettings();
                    this.updateDrawButtonsVisibility();
                });
                
                document.getElementById('enablePoint').addEventListener('change', (e) => {
                    this.settings.enablePoint = e.target.checked;
                    this.saveSettings();
                    this.updateDrawButtonsVisibility();
                });
                
                // æ¨¡å¼è®¾ç½®ç›‘å¬
                Object.keys(this.settings.modes).forEach(mode => {
                    const checkbox = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            this.settings.modes[mode] = e.target.checked;
                            this.saveSettings();
                        });
                    }
                });
                
                // å¿«æ·é”®ç›‘å¬
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        this.drawAll();
                    }
                    if (e.ctrlKey && e.key === 'c' && document.getElementById('copySection').style.display !== 'none') {
                        // å¦‚æœç»“æœåŒºåŸŸæ˜¾ç¤ºï¼Œåˆ™å¤åˆ¶ç»“æœ
                        const copyText = document.getElementById('copyText').textContent;
                        if (copyText && copyText !== '-') {
                            e.preventDefault();
                            this.copyResult();
                        }
                    }
                });
                
                // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
                document.getElementById('historyModal').addEventListener('click', (e) => {
                    if (e.target.id === 'historyModal') {
                        this.hideHistory();
                    }
                });
            }
        }

        // å…¨å±€å®ä¾‹
        let fangweiDrawer;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            fangweiDrawer = new FangweiDrawer();
            console.log('æ–¹ä½æŠ½å–å™¨åŠ è½½å®Œæˆ');
        });

        // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨
        function drawAll() {
            fangweiDrawer.drawAll();
        }

        function drawMode() {
            fangweiDrawer.drawMode();
        }

        function drawDirection() {
            fangweiDrawer.drawDirection();
        }

        function drawPoint() {
            fangweiDrawer.drawPoint();
        }

        function copyResult() {
            fangweiDrawer.copyResult();
        }

        function showHistory() {
            fangweiDrawer.showHistory();
        }

        function hideHistory() {
            fangweiDrawer.hideHistory();
        }        function clearHistory() {
            fangweiDrawer.clearHistory();
        }        // è‡ªå®šä¹‰æ¨¡å¼ç®¡ç†
        function addCustomMode() {
            const name = document.getElementById('customModeName').value;
            
            if (fangweiDrawer && name.trim()) {
                fangweiDrawer.addCustomMode(name);
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('customModeName').value = '';
            } else {
                alert('è¯·è¾“å…¥æ¨¡å¼åç§°');
            }
        }

        // è‡ªå®šä¹‰æ¨¡å¼è¯¦æƒ…å¼¹çª—ç®¡ç†
        function showCustomModeDetail(mode = null) {
            const modal = document.getElementById('customDetailModal');
            const typeSelect = document.getElementById('customModeType');
            const textInput = document.getElementById('customModeText');
            const elementsTextarea = document.getElementById('customModeElements');
            
            // å¦‚æœä¼ å…¥äº†æ¨¡å¼å¯¹è±¡ï¼Œåˆ™ä¸ºç¼–è¾‘æ¨¡å¼
            if (mode) {
                fangweiDrawer.currentEditingMode = mode;
                // å¡«å……ç°æœ‰æ•°æ®
                if (mode.detailConfig) {
                    typeSelect.value = mode.detailConfig.type || 'text';
                    if (mode.detailConfig.type === 'text') {
                        textInput.value = mode.detailConfig.text || '';
                    } else if (mode.detailConfig.type === 'random') {
                        elementsTextarea.value = (mode.detailConfig.elements || []).join('\n');
                    }
                }
            } else {
                fangweiDrawer.currentEditingMode = null;
                // ä½¿ç”¨å½“å‰è¯¦æƒ…é…ç½®
                typeSelect.value = fangweiDrawer.currentCustomDetail.type;
                textInput.value = fangweiDrawer.currentCustomDetail.text;
                elementsTextarea.value = fangweiDrawer.currentCustomDetail.elements.join('\n');
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateCustomDetailDisplay();
            modal.style.display = 'flex';
        }

        function hideCustomDetail() {
            const modal = document.getElementById('customDetailModal');
            const typeSelect = document.getElementById('customModeType');
            const textInput = document.getElementById('customModeText');
            const elementsTextarea = document.getElementById('customModeElements');
            
            // ä¿å­˜å½“å‰é…ç½®
            const detailConfig = {
                type: typeSelect.value,
                text: textInput.value.trim(),
                elements: elementsTextarea.value.split('\n').map(s => s.trim()).filter(s => s)
            };
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ›´æ–°å¯¹åº”çš„è‡ªå®šä¹‰æ¨¡å¼
            if (fangweiDrawer.currentEditingMode) {
                const mode = fangweiDrawer.currentEditingMode;
                mode.detailConfig = detailConfig;
                fangweiDrawer.saveCustomModes();
                fangweiDrawer.updateCustomModesList();
                fangweiDrawer.currentEditingMode = null;
            } else {
                // æ–°å»ºæ¨¡å¼ï¼Œä¿å­˜åˆ°ä¸´æ—¶é…ç½®
                fangweiDrawer.currentCustomDetail = detailConfig;
            }
            
            modal.style.display = 'none';
        }

        function clearCustomDetail() {
            document.getElementById('customModeText').value = '';
            document.getElementById('customModeElements').value = '';
            
            // é‡ç½®å½“å‰è¯¦æƒ…é…ç½®
            if (!fangweiDrawer.currentEditingMode) {
                fangweiDrawer.currentCustomDetail = {
                    type: 'text',
                    text: '',
                    elements: []
                };
            }
        }

        function updateCustomDetailDisplay() {
            const typeSelect = document.getElementById('customModeType');
            const textSection = document.getElementById('textDetailSection');
            const randomSection = document.getElementById('randomDetailSection');
            
            if (typeSelect.value === 'text') {
                textSection.style.display = 'block';
                randomSection.style.display = 'none';
            } else {
                textSection.style.display = 'none';
                randomSection.style.display = 'block';
            }
        }

        // è¯¦æƒ…ç±»å‹æ”¹å˜æ—¶çš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const typeSelect = document.getElementById('customModeType');
            if (typeSelect) {
                typeSelect.addEventListener('change', updateCustomDetailDisplay);
            }
        });

        // æµ‹è¯•åŠŸèƒ½
        function runModeTest() {
            if (!fangweiDrawer) return;
            
            const testCount = 100;
            const results = {
                clone: 0,
                swap: { total: 0, random: 0, fixed: 0 },
                surprise: 0,
                audience: 0,
                normal: 0
            };
            
            // ä¸´æ—¶ä¿å­˜å½“å‰ç»“æœ
            const originalResults = { ...fangweiDrawer.currentResults };
            
            for (let i = 0; i < testCount; i++) {
                fangweiDrawer.drawMode();
                const mode = fangweiDrawer.currentResults.mode;
                const detail = fangweiDrawer.currentResults.modeDetail;
                
                switch (mode) {
                    case 'å…‹éš†':
                        results.clone++;
                        break;
                    case 'äº¤æ¢':
                        results.swap.total++;
                        if (detail.includes('ä»»é€‰äº¤æ¢')) {
                            results.swap.random++;
                        } else {
                            results.swap.fixed++;
                        }
                        break;
                    case 'æƒŠå–œ':
                        results.surprise++;
                        break;
                    case 'è§‚ä¼—':
                        results.audience++;
                        break;
                    case 'æ™®é€š':
                        results.normal++;
                        break;
                }
            }
            
            // æ¢å¤åŸå§‹ç»“æœ
            fangweiDrawer.currentResults = originalResults;
            fangweiDrawer.updateModeDisplay();
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            const testResultsDiv = document.getElementById('testResults');
            const swapRandomPercent = results.swap.total > 0 ? (results.swap.random / results.swap.total * 100).toFixed(1) : 0;
            
            testResultsDiv.innerHTML = `
                <div style="text-align: left; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <strong>æµ‹è¯•ç»“æœ (${testCount}æ¬¡æŠ½å–):</strong><br>
                    å…‹éš†: ${results.clone}æ¬¡ (${(results.clone/testCount*100).toFixed(1)}%)<br>
                    äº¤æ¢: ${results.swap.total}æ¬¡ (${(results.swap.total/testCount*100).toFixed(1)}%) 
                    - ä»»é€‰: ${results.swap.random}æ¬¡ (${swapRandomPercent}%)
                    - å›ºå®š: ${results.swap.fixed}æ¬¡<br>
                    æƒŠå–œ: ${results.surprise}æ¬¡ (${(results.surprise/testCount*100).toFixed(1)}%)<br>
                    è§‚ä¼—: ${results.audience}æ¬¡ (${(results.audience/testCount*100).toFixed(1)}%)<br>
                    æ™®é€š: ${results.normal}æ¬¡ (${(results.normal/testCount*100).toFixed(1)}%)<br>
                    <em>äº¤æ¢æ¨¡å¼ä¸­ä»»é€‰äº¤æ¢ç†è®ºæ¦‚ç‡: 17.15%</em>
                </div>
            `;
            testResultsDiv.style.display = 'block';
            
            // 8ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                testResultsDiv.style.display = 'none';
            }, 8000);
        }

        // æµ‹è¯•è§‚ä¼—åˆ†ç»„åŠŸèƒ½
        function runAudienceTest() {
            if (!fangweiDrawer) return;
            
            const testCount = 50;
            const groupResults = {};
            
            for (let i = 0; i < testCount; i++) {
                const result = fangweiDrawer.generateAudienceGroups();
                if (groupResults[result]) {
                    groupResults[result]++;
                } else {
                    groupResults[result] = 1;
                }
            }
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            // const testResultsDiv = document.getElementById('testResults');
            // let resultHtml = `<div style="text-align: left; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; margin-top: 10px;">
            //     <strong>è§‚ä¼—åˆ†ç»„æµ‹è¯•ç»“æœ (${testCount}æ¬¡):</strong><br>`;
            
            // // æŒ‰é¢‘æ¬¡æ’åºæ˜¾ç¤º
            // const sortedResults = Object.entries(groupResults).sort((a, b) => b[1] - a[1]);
            
            // for (const [group, count] of sortedResults) {
            //     const percentage = (count / testCount * 100).toFixed(1);
            //     resultHtml += `${group}: ${count}æ¬¡ (${percentage}%)<br>`;
            // }
            
            // resultHtml += `<em>æ³¨ï¼šæ¯ä¸ªç©å®¶ç‹¬ç«‹éšæœºåˆ†ç»„ï¼Œç¡®ä¿åˆ†ç»„å¤šæ ·æ€§</em></div>`;
            
            // testResultsDiv.innerHTML = resultHtml;
            // testResultsDiv.style.display = 'block';
            
            // // 10ç§’åè‡ªåŠ¨éšè—
            // setTimeout(() => {
            //     testResultsDiv.style.display = 'none';
            // }, 10000);
        }
    </script>
</body>
</html>
