<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://upload-bbs.miyoushe.com/upload/2024/06/29/273489775/4be47bf1376bfb4f69c1e3fe26c8a8e8_8119842655567179283.png" type="image/png">
    <title>表情编辑器</title>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        <div class="controls">
            <label>添加图片:</label>
            <button id="gallery-btn">选择图片</button>
            <label>添加文案:</label>
            <textarea id="text-input" placeholder="输入文案..."></textarea>
            <label for="font-size-slider">文字大小:</label>
            <input type="range" id="font-size-slider" min="10" max="100" value="70">
            <!-- 移除图片大小控件（直接在画布上拖动/缩放） -->
            <div class="control-row" style="display:none">
                <label for="image-size-slider">图片大小:</label>
                <input type="number" id="image-size-input" min="10" max="250" step="1" value="50" title="图片大小（%）">
            </div>
            <input type="range" id="image-size-slider" min="10" max="250" value="50" style="display:none">
            <div class="tip">
                <h2 style="margin: 5px;">操作提示</h2>
                图片可直接在预览区拖动调整<br>
                <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;">
                    <span style="display:inline-flex; align-items:center; gap:6px;">
                        <span style="display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:6px; background:#e74c3c;">
                            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;color:#fff;fill:currentColor;">
                                <path d="M571.01312 523.776l311.3472-311.35232c15.7184-15.71328 15.7184-41.6256 0-57.344l-1.69472-1.69984c-15.7184-15.71328-41.6256-15.71328-57.34912 0l-311.3472 311.77728-311.35232-311.77728c-15.7184-15.71328-41.63072-15.71328-57.344 0l-1.69984 1.69984a40.0128 40.0128 0 0 0 0 57.344L452.92544 523.776l-311.35232 311.35744c-15.71328 15.71328-15.71328 41.63072 0 57.33888l1.69984 1.69984c15.71328 15.7184 41.6256 15.7184 57.344 0l311.35232-311.35232 311.3472 311.35232c15.72352 15.7184 41.63072 15.7184 57.34912 0l1.69472-1.69984c15.7184-15.70816 15.7184-41.6256 0-57.33888l-311.3472-311.35744z"></path>
                            </svg>
                        </span>
                        删除
                    </span>
                    <span style="display:inline-flex; align-items:center; gap:6px;">
                        <span style="display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:6px; background:rgb(231,223,205);">
                            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;color:#2E2F30;fill:currentColor;">
                                <path d="M164.778667 263.978667a425.258667 425.258667 0 0 1 236.8-164.096C629.162667 38.826667 863.146667 173.952 924.117333 401.493333c61.013333 227.626667-74.069333 461.610667-301.653333 522.581334C394.794667 985.173333 160.853333 850.048 99.84 622.506667l82.432-22.101334a341.333333 341.333333 0 1 0 54.570667-290.432l80.384 51.2-182.912 54.101334L85.333333 213.333333l79.445334 50.645334z"></path>
                                <path d="M512 512m-85.333333 0a85.333333 85.333333 0 1 0 170.666666 0 85.333333 85.333333 0 1 0-170.666666 0Z"></path>
                            </svg>
                        </span>
                        旋转
                    </span>
                    <span style="display:inline-flex; align-items:center; gap:6px;">
                        <span style="display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:6px; background:rgb(231,223,205);">
                            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;color:#2E2F30;fill:currentColor;">
                                <path d="M476.8 889.6h-176c-91.2 0-164.8-74.4-164.8-165.6v-424c0-91.2 73.6-165.6 164.8-165.6h422.4c91.2 0 164.8 74.4 164.8 165.6v176.8c0 13.6-10.4 24-24 24s-24-10.4-24-24V300c0-64.8-52-117.6-116.8-117.6H300.8c-64.8 0-116.8 52.8-116.8 117.6v424c0 64.8 52 117.6 116.8 117.6h176c13.6 0 24 10.4 24 24s-10.4 24-24 24z"></path>
                                <path d="M806.4 889.6H633.6c-44.8 0-81.6-36.8-81.6-81.6V635.2c0-44.8 36.8-81.6 81.6-81.6h172.8c44.8 0 81.6 36.8 81.6 81.6V808c0 44.8-36.8 81.6-81.6 81.6z m-172.8-288c-19.2 0-33.6 14.4-33.6 33.6V808c0 19.2 14.4 33.6 33.6 33.6h172.8c19.2 0 33.6-14.4 33.6-33.6V635.2c0-19.2-14.4-33.6-33.6-33.6H633.6z"></path>
                            </svg>
                        </span>
                        缩放
                    </span>
                    <span style="display:inline-flex; align-items:center; gap:6px;">
                        <span style="display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:6px; background:rgb(231,223,205);">
                            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;color:#2E2F30;fill:currentColor;">
                                <path d="M128.1536 160.9216A21.0944 21.0944 0 0 1 134.144 143.36c4.9664-15.2064 15.7696-27.8528 30.0032-35.1232C170.1888 102.4 182.1696 102.4 188.2112 102.4h647.8336c35.9936 0 59.9552 23.3984 59.9552 58.5216 0 11.6736 0 17.5104-5.9904 23.3984L770.048 418.304c-12.032 23.4496-30.0032 35.1232-54.016 35.1232H308.1216c-24.0128 0-41.984-11.7248-54.016-35.1232L134.1952 184.32c0-5.888-6.0416-11.7248-6.0416-23.4496z m707.8912 0H188.16l119.9616 234.0352h407.9104l120.0128-234.0352zM128.1536 863.0784c0-11.6736 0-17.5616 5.9904-23.3984l120.0128-234.0352c11.9808-23.4496 29.952-35.1232 53.9648-35.1232h407.9104c24.0128 0 41.984 11.6736 54.016 35.072l119.9616 234.0864c5.9904 5.8368 5.9904 17.5616 5.9904 23.3984 0 35.1232-23.9616 58.5216-60.0064 58.5216H188.16c-11.9808 0-17.9712 0-24.0128-5.8368a60.3648 60.3648 0 0 1-29.952-35.1232 21.248 21.248 0 0 1-6.0416-17.5616z m707.84 0l-119.9616-234.0352H308.1216l-119.9616 234.0352h647.8848z"></path>
                            </svg>
                        </span>
                        镜像
                    </span>
                </div>
                <br>旋转和缩放需按住并拖动<br>动图请选择GIF格式导出<br>
                <a id="show-guide-link" href="javascript:void(0);" style="display:inline-block; margin-top:6px; font-size:13px; color:#8b6b3e; text-decoration:underline; cursor:pointer;">详细提示</a><br>
                <button id="usage-tip-dismiss-btn" type="button" style="margin-top:10px; padding:6px 14px; background:#e7dfcd; border:1px solid #c9bba2; border-radius:8px; cursor:pointer; font-size:13px; color:#2c2f36; display:inline-block;">我知道了(不再提示)</button>
            </div>
            <label for="format-select">导出格式:</label>
            <select id="format-select">
                <option value="png">PNG</option>
                <option value="gif">GIF</option>
            </select>
            <label for="quality-select">导出质量:（预计大小仅参考）</label>
            <select id="quality-select">
                <option value="none">100%</option>
                <option value="80">80%（预估中…）</option>
                <option value="60">60%（预估中…）</option>
                <option value="40">40%（预估中…）</option>
                <option value="20">20%（预估中…）</option>
            </select>
            <button id="download-btn">下载图片</button>
            <button id="copy-btn">复制图片</button>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="gallery-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>图片库</h2>
            <div id="category-container" class="category-container">
                <!-- Categories will be inserted here by JS -->
            </div>
            <!-- Custom image category area -->
            <div id="custom-image-panel" class="custom-image-panel" style="display:none;">
                <div class="custom-inputs">
                    <label for="image-upload" class="custom-label">上传图片（无法记录到“最近使用”）</label>
                    <input type="file" id="image-upload" accept="image/*" class="custom-file">
                    <div class="or-divider"><span>或</span></div>
                    <label for="image-url-input" class="custom-label">输入图片 URL</label>
                    <input type="text" id="image-url-input" placeholder="https://..." class="custom-url">
                    <div class="custom-preview" id="custom-preview" style="display:none;">
                        <img id="custom-preview-img" alt="预览" />
                        <button id="preview-zoom-btn" type="button" title="放大查看" style="display:none; position:absolute; top:6px; right:6px; width:32px; height:32px; border:1px solid #c9bba2; background:rgba(255,255,255,0.85); backdrop-filter:blur(4px); border-radius:8px; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center;">
                            <svg viewBox="0 0 1024 1024" width="18" height="18" fill="#2E2F30" aria-hidden="true">
                                <path d="M447 128c176.7 0 320 143.3 320 320 0 70.4-22.7 135.5-61.3 188.3l182.5 182.5c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L660.3 681.9C607.5 720.3 542.4 743 472 743 295.3 743 152 599.7 152 423S295.3 128 472 128h-25zm0 64c-141.4 0-256 114.6-256 256s114.6 256 256 256 256-114.6 256-256S588.4 192 447 192z"/>
                            </svg>
                        </button>
                    </div>
                    <!-- 简易抠图工具 -->
                    <div id="bg-remove-tools" style="display:none; margin-top:10px; padding:8px 10px; background:rgba(0,0,0,0.05); border:1px solid #d3c7b3; border-radius:8px;">
                        <div style="font-size:12px; color:#444; line-height:1.4;">
                            (可选图片预处理)简单去除背景：精确点击上方预览图背景颜色位置，被选颜色及其阈值范围内的像素将被设为透明。
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:8px;" id="bg-tools-inner">
                            <div id="picked-color-box" style="display:flex; align-items:center; gap:6px;">
                                <span style="font-size:12px; color:#555;">当前颜色:</span>
                                <span id="picked-color-swatch" style="width:28px; height:28px; border-radius:6px; border:1px solid #888; background:linear-gradient(45deg,#ccc,#eee); display:inline-block;"></span>
                                <span id="picked-color-placeholder" style="font-size:11px; color:#888;">请点击选择颜色</span>
                            </div>
                            <div id="picked-color-info" style="flex:1 1 100%; font-size:11px; color:#666; line-height:1.4; padding-left:2px; display:none;">
                                颜色: -  阈值范围: -  
                                <span id="picked-range-preview" style="display:inline-block; width:80px; height:14px; vertical-align:middle; border:1px solid #aaa; border-radius:4px; background:repeating-linear-gradient(45deg,#ddd,#ddd 6px,#f3f3f3 6px,#f3f3f3 12px);"></span>
                            </div>
                            <div id="bg-threshold-wrapper" style="display:none; align-items:center; gap:4px;">
                                <label for="bg-threshold" style="font-size:12px; color:#555;">阈值</label>
                                <input type="range" id="bg-threshold" min="0" max="180" value="40" style="width:140px;">
                                <span id="bg-threshold-val" style="font-size:12px; color:#333; width:32px; text-align:right;">40</span>
                            </div>
                            <button id="bg-reset-btn" type="button" style="display:none; font-size:12px; padding:4px 10px; background:#e7dfcd; border:1px solid #c9bba2; border-radius:6px; cursor:pointer;">重置</button>
                        </div>
                        <div style="margin-top:4px; font-size:11px; color:#666; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                            <span>提示：背景扣除不完全请加大阈值，主体被扣除请减小阈值。复杂背景扣除请前往</span>
                            <span title="Photoshop" style="display:inline-flex; width:22px; height:22px;">
                                <svg viewBox="0 0 240 234" width="22" height="22" aria-label="Photoshop" role="img">
                                    <path fill="#001E36" d="M42.5,0h155C221,0,240,19,240,42.5v149c0,23.5-19,42.5-42.5,42.5h-155C19,234,0,215,0,191.5v-149C0,19,19,0,42.5,0z"/>
                                    <path fill="#31A8FF" d="M54,164.1V61.2c0-0.7,0.3-1.1,1-1.1c1.7,0,3.3,0,5.6-0.1c2.4-0.1,4.9-0.1,7.6-0.2c2.7-0.1,5.6-0.1,8.7-0.2c3.1-0.1,6.1-0.1,9.1-0.1c8.2,0,15,1,20.6,3.1c5,1.7,9.6,4.5,13.4,8.2c3.2,3.2,5.7,7.1,7.3,11.4c1.5,4.2,2.3,8.5,2.3,13c0,8.6-2,15.7-6,21.3c-4,5.6-9.6,9.8-16.1,12.2c-6.8,2.5-14.3,3.4-22.5,3.4c-2.4,0-4,0-5-0.1c-1-0.1-2.4-0.1-4.3-0.1v32.1c0.1,0.7-0.4,1.3-1.1,1.4c-0.1,0-0.2,0-0.4,0H55.2C54.4,165.4,54,165,54,164.1z M75.8,79.4V113c1.4,0.1,2.7,0.2,3.9,0.2H85c3.9,0,7.8-0.6,11.5-1.8c3.2-0.9,6-2.8,8.2-5.3c2.1-2.5,3.1-5.9,3.1-10.3c0.1-3.1-0.7-6.2-2.3-8.9c-1.7-2.6-4.1-4.6-7-5.7c-3.7-1.5-7.7-2.1-11.8-2c-2.6,0-4.9,0-6.8,0.1C77.9,79.2,76.5,79.3,75.8,79.4L75.8,79.4z"/>
                                    <path fill="#31A8FF" d="M192,106.9c-3-1.6-6.2-2.7-9.6-3.4c-3.7-0.8-7.4-1.3-11.2-1.3c-2-0.1-4.1,0.2-6,0.7c-1.3,0.3-2.4,1-3.1,2c-0.5,0.8-0.8,1.8-0.8,2.7c0,0.9,0.4,1.8,1,2.6c0.9,1.1,2.1,2,3.4,2.7c2.3,1.2,4.7,2.3,7.1,3.3c5.4,1.8,10.6,4.3,15.4,7.3c3.3,2.1,6,4.9,7.9,8.3c1.6,3.2,2.4,6.7,2.3,10.3c0.1,4.7-1.3,9.4-3.9,13.3c-2.8,4-6.7,7.1-11.2,8.9c-4.9,2.1-10.9,3.2-18.1,3.2c-4.6,0-9.1-0.4-13.6-1.3c-3.5-0.6-7-1.7-10.2-3.2c-0.7-0.4-1.2-1.1-1.1-1.9v-17.4c0-0.3,0.1-0.7,0.4-0.9c0.3-0.2,0.6-0.1,0.9,0.1c3.9,2.3,8,3.9,12.4,4.9c3.8,1,7.8,1.5,11.8,1.5c3.8,0,6.5-0.5,8.3-1.4c1.6-0.7,2.7-2.4,2.7-4.2c0-1.4-0.8-2.7-2.4-4c-1.6-1.3-4.9-2.8-9.8-4.7c-5.1-1.8-9.8-4.2-14.2-7.2c-3.1-2.2-5.7-5.1-7.6-8.5c-1.6-3.2-2.4-6.7-2.3-10.2c0-4.3,1.2-8.4,3.4-12.1c2.5-4,6.2-7.2,10.5-9.2c4.7-2.4,10.6-3.5,17.7-3.5c4.1,0,8.3,0.3,12.4,0.9c3,0.4,5.9,1.2,8.6,2.3c0.4,0.1,0.8,0.5,1,0.9c0.1,0.4,0.2,0.8,0.2,1.2v16.3c0,0.4-0.2,0.8-0.5,1C192.9,107.1,192.4,107.1,192,106.9z"/>
                                </svg>
                            </span>
                        </div>
                    </div>
                    <button id="custom-use-btn" class="custom-use-btn">使用该图片</button>
                </div>
            </div>
            <div id="image-gallery" class="image-gallery">
                <!-- Images will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- GIF 解码库：通过 ESM CDN 引入并挂到 window 供 script.js 使用 -->
    <!-- 预览放大弹窗 -->
    <div id="zoom-preview-modal" class="modal-overlay" style="display:none;">
        <div class="zoom-modal-content">
            <span class="zoom-close" id="zoom-close-btn">&times;</span>
            <div class="zoom-img-wrap">
                <img id="zoom-preview-img" alt="放大预览" />
            </div>
            <div class="zoom-tools" id="zoom-tools" style="display:flex; flex-direction:column; gap:8px;">
                <div style="font-size:12px; color:#444;">简单去除背景：精确点击上方预览图背景颜色位置，被选颜色及其阈值范围内的像素将被设为透明。</div>
                <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;" id="bg-tools-inner-big">
                    <div id="picked-color-box-big" style="display:flex; align-items:center; gap:6px;">
                        <span style="font-size:12px; color:#555;">当前颜色:</span>
                        <span id="picked-color-swatch-big" style="width:28px; height:28px; border-radius:6px; border:1px solid #888; background:linear-gradient(45deg,#ccc,#eee); display:inline-block;"></span>
                        <span id="picked-color-placeholder-big" style="font-size:11px; color:#888;">请点击选择颜色</span>
                    </div>
                    <div id="picked-color-info-big" style="flex:1 1 100%; font-size:11px; color:#666; line-height:1.4; padding-left:2px; display:none;">颜色: -  阈值范围: -  <span id="picked-range-preview-big" style="display:inline-block; width:80px; height:14px; vertical-align:middle; border:1px solid #aaa; border-radius:4px; background:repeating-linear-gradient(45deg,#ddd,#ddd 6px,#f3f3f3 6px,#f3f3f3 12px);"></span></div>
                    <div id="bg-threshold-wrapper-big" style="display:none; align-items:center; gap:4px;">
                        <label for="bg-threshold-big" style="font-size:12px; color:#555;">阈值</label>
                        <input type="range" id="bg-threshold-big" min="0" max="180" value="40" style="width:140px;">
                        <span id="bg-threshold-val-big" style="font-size:12px; color:#333; width:32px; text-align:right;">40</span>
                    </div>
                    <button id="bg-reset-btn-big" type="button" style="display:none; font-size:12px; padding:4px 10px; background:#e7dfcd; border:1px solid #c9bba2; border-radius:6px; cursor:pointer;">重置</button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { parseGIF, decompressFrames } from 'https://esm.sh/gifuct-js@2.1.2';
        window.gifuctJs = { parseGIF, decompressFrames };
    </script>
    <!-- GIF 编码库（gif.js.optimized）用于导出动图 -->
    <script src="https://unpkg.com/gif.js.optimized/dist/gif.js"></script>
    <script src="script.js" defer></script>
    <!-- 详细提示弹窗结构 -->
    <div id="guide-overlay" class="guide-overlay" style="display:none;">
        <div class="guide-wrapper">
            <button id="guide-close-btn" class="guide-close" aria-label="关闭">&times;</button>
            <img src="Guide.png" alt="详细操作指南" class="guide-image" />
        </div>
    </div>
    <!-- 复制失败备用弹窗：展示图片，方便用户长按/系统菜单复制 -->
    <div id="copy-fallback-overlay" class="guide-overlay" style="display:none;">
        <div class="guide-wrapper" style="display:flex; flex-direction:column; gap:10px; align-items:center;">
            <button id="copy-fallback-close" class="guide-close" aria-label="关闭">&times;</button>
            <div style="background:#fff; border:1px solid rgb(209,191,162); border-radius:10px; padding:10px 12px; color:#2c2f36; font-size:14px; text-align:center; max-width:min(92vw, 1000px);">
                复制失败或浏览器不支持，请长按图片通过浏览器菜单进行复制。
            </div>
            <img id="copy-fallback-img" class="guide-image" alt="复制备用图片" />
        </div>
    </div>
</body>
</html>
