<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>随机Ban位</title>
  <link rel="icon"
    href="https://bbs-static.miyoushe.com/static/2024/06/12/7982e4f54092be80c43a251f26e44235_6026540790739799944.png"
    type="image/png">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/stats.css" />
  <link rel="stylesheet" href="css/settings.css" />
  <link rel="stylesheet" href="css/context-menu.css" />
  <link rel="stylesheet" href="css/HYWenHei-85W.css" />
  <link rel="stylesheet" href="css/light.css" id="lightThemeLink" disabled>
</head>

<body>
  <div class="container">
    <header
      style="position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <h1 style="margin: 0;">随机Ban位</h1>
      <button id="settingsBtn" title="设置" style="position: absolute; right: 0;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
      </button>
    </header>

    <!-- 在线房间信息栏 -->
    <div id="onlineRoomBar" class="panel online-room-bar hidden">
      <div class="room-bar-left">
        <span id="roomModeDisplay" class="room-mode">观众模式</span>
        <span id="connectionStatus" class="room-status"></span>
        <span class="room-divider"></span>
        <span class="room-label">房间</span>
        <span id="roomCodeDisplay" class="room-code">------</span>
      </div>
      <div class="room-bar-right">
        <button id="copyRoomLinkBtn" class="btn btn-icon" title="复制房间链接">
          <!-- Replced with 'Copy' icon -->
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
          </svg>
        </button>
        <div class="qr-wrapper">
          <button id="showQRBtn" class="btn btn-icon" title="显示房间二维码">
            <!-- Replaced with simplified 'QR' icon -->
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7" rx="1" />
              <rect x="14" y="3" width="7" height="7" rx="1" />
              <rect x="3" y="14" width="7" height="7" rx="1" />
              <path d="M14 17h7" />
              <path d="M17 14v7" />
            </svg>
          </button>
          <div id="qrPopover" class="qr-popover hidden">
            <canvas id="qrCanvas"></canvas>
          </div>
        </div>
        <button id="leaveRoomBtn" class="btn btn-icon danger" title="离开房间">
          <!-- Refined 'Log Out' icon -->
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="layout-desktop">
      <div class="left-column">
        <section class="panel">
          <div class="panel-header">
            <h2>本次Ban位抽取</h2>
            <div class="controls inline-controls">
              <!-- Copy button moved here -->
              <div id="lastCopyBar" class="hidden">
                <button id="copyLastBtn" class="btn btn-icon" title="复制本次结果" aria-label="复制">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                  </svg>
                </button>
              </div>
              <button id="drawBtn" class="btn primary">抽取</button>
            </div>
          </div>
          <div class="rows" id="lastDraw"></div>
        </section>
        <section class="panel">
          <div class="panel-header">
            <h2>当前Ban位记录</h2>
            <div class="controls hidden" id="recordCopyBar">
              <button id="copyRecordBtn" class="btn btn-icon" title="复制当前记录" aria-label="复制">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
              </button>
            </div>
          </div>
          <div class="rows" id="record"></div>
        </section>
        <!-- 可用角色分段复制区域移至左侧 -->
        <section class="panel hidden" id="copyAvailablePanel">
          <div class="panel-header">
            <h2>复制可用角色</h2>
          </div>
          <div id="copyAvailable" class="copy-container"></div>
        </section>
      </div>
      <div class="right-column">
        <section class="panel" id="availablePanel">
          <div class="panel-header" style="justify-content: space-between; margin-bottom: 12px;">
            <h2 style="margin-bottom: 0;">当前可用角色</h2>
            <div class="header-search-container" id="panelSearchContainer">
              <input type="text" id="panelSearchInput" class="search-input" placeholder="搜索角色/拼音..." autocomplete="off">
              <button id="panelSearchBtn" class="btn-search" title="搜索角色">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </button>
            </div>
          </div>
          <div class="stats" id="stats"></div>

          <!-- 脑筋急转弯模式容器 -->
          <div id="brainTeaserContainer" class="hidden" style="text-align: center;">
            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 8px;">
              <input type="text" id="btInput" placeholder="输入拼音首字母或全名" class="settings-select" style="width: 220px;">
              <button id="btSearchBtn" class="btn primary">确认</button>
            </div>
            <div style="font-size: 0.4rem; color: #94a3b8; opacity: 0.2;">
              输入“我是笨蛋”可临时展示可用角色
            </div>
            <div id="btResult" class="card-grid" style="justify-content: center;"></div>
          </div>

          <div class="card-grid" id="complementList"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- 设置弹窗 -->
  <div id="settingsModal" class="settings-modal hidden">
    <div class="settings-backdrop"></div>
    <div class="settings-dialog">
      <div class="settings-header">
        <h2>设置</h2>
        <button class="settings-close">&times;</button>
      </div>

      <div class="settings-body">
        <h4 class="settings-subtitle" style="text-align: center; margin-top: 0px;">游戏规则</h4>
        <!-- Rules Details -->
        <details class="rules-details" id="rulesDetails">
          <summary class="rules-summary">
            <div class="settings-info">
              <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>查看游戏规则</div>
              <div class="settings-desc">点击展开或收起随机 Ban 位玩法说明</div>
            </div>
            <div class="rules-arrow"></div>
          </summary>
          <div class="rules-anim-container">
            <div class="rules-content">
              <h2 style="text-align: center;">随机Ban位</h2>
              <hr style="color: #94a3b8; opacity: 0.5;">
              <h3>1. 抽取规则</h3>
              <p>每轮随机从四个维度各抽取一个词条。</p>
              <table class="rules-table">
                <thead>
                  <tr>
                    <th>类别</th>
                    <th>词条选项</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>元素</td>
                    <td>①水系、②火系、③冰系、④风系、⑤雷系、⑥草系、⑦岩系</td>
                  </tr>
                  <tr>
                    <td>国家</td>
                    <td>①蒙德、②璃月、③稻妻、④须弥、⑤枫丹、⑥纳塔、⑦挪德卡莱</td>
                  </tr>
                  <tr>
                    <td>体型</td>
                    <td>①萝莉、②少女、③少年、④成女、⑤成男</td>
                  </tr>
                  <tr>
                    <td>武器</td>
                    <td>①弓箭、②法器、③长柄武器、④单手剑、⑤双手剑</td>
                  </tr>
                </tbody>
              </table>
              <ul>
                <li>角色的国家以<strong>「米游社观测枢角色图鉴」</strong>的<strong>「地区」</strong>分类为准。</li>
                <li>两个奇偶无<strong>元素</strong>和<strong>国家</strong>标签，选择时只考虑体型和武器。</li>
              </ul>

              <h3>2. 解禁规则</h3>
              <p>每轮抽取到的 4 个词条将被记录整合。</p>
              <ul>
                <li>抽到当前记录中<strong>没有</strong>的词条时，此词条<strong>加入</strong>记录。</li>
                <li>抽到当前记录中<strong>已有</strong>的词条时，此词条<strong>移除</strong>记录。</li>
              </ul>
              <h3>3. 选角规则</h3>
              <ul>
                <li>每轮只能选择<strong>不符合当前记录中任何特征</strong>的角色，无角色可用时使用旅行者。</li>
                <li>角色不BP，可以重复使用角色。</li>
              </ul>
              <h3>概率参考</h3>
              <p>基于百万次模拟（1000000次×10回合「三点一换」和30回合「一点一换」）计算的期望数据：</p>
              <table class="rules-table stats-reference-table">
                <thead>
                  <tr>
                    <th>抽取模式</th>
                    <th>平均可用</th>
                    <th>标准差</th>
                    <th>零可用概率</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>三点一换</td>
                    <td>17.02</td>
                    <td>16.34</td>
                    <td>5.12%</td>
                  </tr>
                  <tr>
                    <td>一点一换</td>
                    <td>10.55</td>
                    <td>12.03</td>
                    <td>9.28%</td>
                  </tr>
                </tbody>
              </table>
              <p>总结：请做好坐牢的准备 <img
                  src="https://upload-bbs.miyoushe.com/upload/2024/06/29/273489775/4be47bf1376bfb4f69c1e3fe26c8a8e8_8119842655567179283.png"
                  style="height: 4em; vertical-align: middle;"></p>

            </div>
          </div>
        </details>

        <div class="settings-item" id="viewAllTagsItem">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
                <line x1="7" y1="7" x2="7.01" y2="7" />
              </svg>查看角色标签</div>
            <div class="settings-desc">查看所有角色的标签信息</div>
          </div>
          <div class="settings-action">
            <button class="btn primary" id="viewAllTagsBtn">查看</button>
          </div>
        </div>

        <div class="settings-item host-only">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
              </svg>脑筋急转弯模式</div>
            <div class="settings-desc">隐藏可用角色展示，变为输入来验证角色是否可用</div>
          </div>
          <div class="settings-action">
            <label class="switch">
              <input type="checkbox" id="brainTeaserToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <h4 class="settings-subtitle">基础操作</h4>

        <div class="settings-item host-only">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="1 4 1 10 7 10" />
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
              </svg>撤销操作</div>
            <div class="settings-desc">回退到上一次抽取状态</div>
          </div>
          <div class="settings-action">
            <button id="modalUndoBtn" class="btn primary">撤销</button>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>历史记录与统计信息</div>
            <div class="settings-desc">查看详细的抽取历史和统计信息</div>
          </div>
          <div class="settings-action">
            <button id="modalHistoryBtn" class="btn primary">查看</button>
          </div>
        </div>
        <div class="settings-item host-only">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              </svg>重置记录</div>
            <div class="settings-desc">清除所有抽取历史和当前记录</div>
          </div>
          <div class="settings-action">
            <button id="modalResetBtn" class="btn primary danger">重置</button>
          </div>
        </div>

        <h4 class="settings-subtitle">界面设置</h4>

        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3" />
              </svg>启用抽取动画</div>
            <div class="settings-desc">开启后抽取过程会有逐步显示的动画效果</div>
          </div>
          <div class="settings-action">
            <label class="switch">
              <input type="checkbox" id="animToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5" />
                <line x1="12" y1="1" x2="12" y2="3" />
                <line x1="12" y1="21" x2="12" y2="23" />
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                <line x1="1" y1="12" x2="3" y2="12" />
                <line x1="21" y1="12" x2="23" y2="12" />
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
              </svg>外观主题</div>
            <div class="settings-desc">切换界面的颜色主题</div>
          </div>
          <div class="settings-action">
            <select id="themeSelect" class="settings-select">
              <option value="light">浅色</option>
              <option value="dark">深色</option>
              <option value="system">跟随系统</option>
            </select>
          </div>
        </div>

        <details class="rules-details shortcut-section" id="shortcutDetails">
          <summary class="rules-summary">
            <div class="settings-info">
              <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v10" />
                  <path d="M12 22v-4" />
                  <path d="M2 12h8" />
                  <path d="M22 12h-4" />
                  <path d="M5.64 5.64l2.83 2.83" />
                  <path d="M18.36 18.36l-2.83-2.83" />
                  <path d="M18.36 5.64l-2.83 2.83" />
                  <path d="M5.64 18.36l2.83-2.83" />
                </svg>快捷键设置</div>
              <div class="settings-desc">配置抽取与复制相关的快捷键</div>
            </div>
            <div class="rules-arrow"></div>
          </summary>
          <div class="rules-anim-container">
            <div class="rules-content">
              <div class="settings-item shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z" />
                      <path d="M13 13l6 6" />
                    </svg>覆盖浏览器右键菜单</div>
                  <div class="settings-desc">开启后覆盖浏览器右键菜单，展示与此应用相关的功能。</div>
                </div>
                <div class="settings-action">
                  <label class="switch">
                    <input type="checkbox" id="contextMenuToggle" checked>
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
              <div class="settings-item host-only shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="16 3 21 3 21 8" />
                      <line x1="4" y1="20" x2="21" y2="3" />
                      <polyline points="21 16 21 21 16 21" />
                      <line x1="15" y1="15" x2="21" y2="21" />
                      <line x1="4" y1="4" x2="9" y2="9" />
                    </svg>抽取 Ban 位</div>
                  <div class="settings-desc">进行一次抽取</div>
                </div>
                <div class="settings-action">
                  <input type="text" class="shortcut-input" data-type="draw" readonly>
                  <div class="conflict-msg">快捷键冲突</div>
                </div>
              </div>
              <div class="settings-item shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                    </svg>复制一条龙</div>
                  <div class="settings-desc">开启后将三个复制操作合并为一个顺序循环快捷键</div>
                </div>
                <div class="settings-action">
                  <label class="switch">
                    <input type="checkbox" id="allInOneToggle">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
              <div class="settings-item shortcut-section" id="allInOneShortcutItem" style="display: none;">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path
                        d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z" />
                    </svg>复制一条龙快捷键</div>
                  <div class="settings-desc">依次复制：本次抽取 -> 当前记录 -> 可用角色</div>
                </div>
                <div class="settings-action">
                  <input type="text" class="shortcut-input" data-type="copyAllInOne" readonly>
                  <div class="conflict-msg">快捷键冲突</div>
                </div>
              </div>

              <div class="settings-item shortcut-individual shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                      <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                    </svg>复制本次抽取</div>
                  <div class="settings-desc">复制本次抽取的结果</div>
                </div>
                <div class="settings-action">
                  <input type="text" class="shortcut-input" data-type="lastDraw" readonly>
                  <div class="conflict-msg">快捷键冲突</div>
                </div>
              </div>
              <div class="settings-item shortcut-individual shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                      <polyline points="14 2 14 8 20 8" />
                      <line x1="16" y1="13" x2="8" y2="13" />
                      <line x1="16" y1="17" x2="8" y2="17" />
                      <polyline points="10 9 9 9 8 9" />
                    </svg>复制当前记录</div>
                  <div class="settings-desc">复制当前Ban位记录</div>
                </div>
                <div class="settings-action">
                  <input type="text" class="shortcut-input" data-type="currentRecord" readonly>
                  <div class="conflict-msg">快捷键冲突</div>
                </div>
              </div>
              <div class="settings-item shortcut-individual shortcut-section">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                      <circle cx="9" cy="7" r="4" />
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>复制可用角色</div>
                  <div class="settings-desc">依次复制下方可用角色分段</div>
                </div>
                <div class="settings-action">
                  <input type="text" class="shortcut-input" data-type="availableChars" readonly>
                  <div class="conflict-msg">快捷键冲突</div>
                </div>
              </div>
            </div>
          </div>
        </details>

        <details class="rules-details" id="personalizeDetails">
          <summary class="rules-summary">
            <div class="settings-info">
              <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20h9"></path>
                  <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>界面个性化设置</div>
              <div class="settings-desc">设置徽标、头像显示等外观选项</div>
            </div>
            <div class="rules-arrow"></div>
          </summary>
          <div class="rules-anim-container">
            <div class="rules-content">
              <h4 class="settings-subtitle">界面元素设置</h4>
              <div class="settings-item" style="margin-top: 10px; padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>徽标显示模式</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">设置Ban位徽标的显示样式（手机推荐选择仅图标）</div>
                </div>
                <div class="settings-action">
                  <select id="badgeModeSelect" class="settings-select">
                    <option value="icon-text">图标 + 文字</option>
                    <option value="text">仅文字</option>
                    <option value="icon">仅图标</option>
                  </select>
                </div>
              </div>
              <div class="settings-item" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10" />
                      <circle cx="12" cy="10" r="3" />
                      <path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662" />
                    </svg>角色头像显示</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">设置可用角色列表中头像的显示样式</div>
                </div>
                <div class="settings-action">
                  <select id="avatarModeSelect" class="settings-select">
                    <option value="default">默认（证件照）</option>
                    <option value="emoji">派蒙的画作</option>
                  </select>
                </div>
              </div>
              <div class="settings-item hidden" id="displayPrefItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>《派蒙的画作》头像显示设置</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">设置每个角色使用的表情包</div>
                </div>
                <div class="settings-action">
                  <button class="btn primary" id="displayPrefBtn">编辑</button>
                </div>
              </div>
        <h4 class="settings-subtitle">墙纸设置</h4>
              <div class="settings-item" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <circle cx="8.5" cy="8.5" r="1.5" />
                      <path d="M21 15l-5-5L5 21" />
                    </svg>页面背景</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">选择使用默认背景、纯色、自定义图片或表情符号墙纸</div>
                </div>
                <div class="settings-action">
                  <select id="personalizeBgMode" class="settings-select">
                    <option value="default">默认</option>
                    <option value="color">自定义颜色</option>
                    <option value="image">自定义图片</option>
                    <option value="emoji">表情符号</option>
                  </select>
                </div>
              </div>

              <div class="settings-item" id="personalizeBgColorItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"></circle>
                      <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"></circle>
                      <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"></circle>
                      <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"></circle>
                      <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.551-2.5 5.551-5.652C22 5.61 17.5 2 12 2z"></path>
                    </svg>背景颜色</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">选择背景颜色</div>
                </div>
                <div class="settings-action">
                  <input type="color" id="personalizeBgColor" class="settings-color-input" aria-label="背景颜色">
                </div>
              </div>

              <div class="settings-item" id="personalizeBgImageItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <circle cx="8.5" cy="8.5" r="1.5" />
                      <path d="M21 15l-5-5L5 21" />
                    </svg>背景图片</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">上传本地图片作为背景</div>
                </div>
                <div class="settings-action settings-action-inline">
                  <input type="file" id="personalizeBgImage" class="settings-file-input" accept="image/*">
                  <button class="btn" id="personalizeBgClear">清除</button>
                </div>
              </div>

              <div class="settings-item" id="personalizeEmojiItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10" />
                      <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                      <line x1="9" y1="9" x2="9.01" y2="9" />
                      <line x1="15" y1="9" x2="15.01" y2="9" />
                    </svg>表情符号素材</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">从表情库中选择 1-12 张作为素材</div>
                  <div class="settings-desc" id="personalizeEmojiCount" style="font-size: 0.75rem;">已选 0 / 12</div>
                </div>
                <div class="settings-action">
                  <button class="btn primary" id="personalizeEmojiPickBtn">选择素材</button>
                </div>
              </div>

              <div class="settings-item" id="personalizeEmojiLayoutItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title" style="font-size: 0.95rem;"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 3h7v7H3z" />
                      <path d="M14 3h7v7h-7z" />
                      <path d="M14 14h7v7h-7z" />
                      <path d="M3 14h7v7H3z" />
                    </svg>排列方式</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">选择表情符号排列效果</div>
                </div>
                <div class="settings-action">
                  <select id="personalizeEmojiLayout" class="settings-select">
                    <option value="grid">网格</option>
                    <option value="diamond">菱形</option>
                    <option value="hex">六边形</option>
                    <option value="spiral">螺旋</option>
                    <option value="foam">泡泡</option>
                    <option value="mix">堆叠</option>
                  </select>
                </div>
              </div>

              <!-- 表情大小选择 -->
              <div class="settings-item" id="personalizeEmojiScaleItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                    </svg>表情大小</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">调整表情符号的显示尺寸</div>
                </div>
                <div class="settings-action" style="display: flex; align-items: center; gap: 10px;">
                  <button class="btn btn-icon" id="emojiScaleDecrease" style="width: 28px; height: 28px; padding: 0;">-</button>
                  <span id="personalizeEmojiScaleValue" style="min-width: 3em; text-align: center; font-variant-numeric: tabular-nums; font-size: 0.9rem;">1.0</span>
                  <button class="btn btn-icon" id="emojiScaleIncrease" style="width: 28px; height: 28px; padding: 0;">+</button>
                </div>
              </div>

              <div class="settings-item" id="personalizePreviewItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02); align-items: flex-start;">
                <div class="settings-info" style="width: 100%;">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="14" rx="2" ry="2" />
                      <path d="M8 10h8" />
                      <path d="M8 14h5" />
                    </svg>预览墙纸
                    <button id="refreshSeedBtn" class="btn primary" style="margin-left: auto;" title="刷新随机种子">
                      <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                      </svg>
                    </button>
                  </div>
                  <div class="settings-desc" style="font-size: 0.8rem;">显示当前生成的表情符号墙纸预览</div>
                  <div class="settings-action" style="margin-top: 10px; width: 100%;">
                    <div id="personalizePreviewBox" style="width: 100%; aspect-ratio: 9 / 16; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(0, 0, 0, 0.25);">
                      <img id="personalizePreviewImage" alt="墙纸预览" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                    </div>
                  </div>
                </div>
              </div>

              <div class="settings-item" id="personalizeDownloadItem" style="padding: 10px 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.02);">
                <div class="settings-info">
                  <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="7 10 12 15 17 10" />
                      <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>保存墙纸</div>
                  <div class="settings-desc" style="font-size: 0.8rem;">下载当前生成的表情符号墙纸</div>
                </div>
                <div class="settings-action" style="display: flex; gap: 8px;">
                  <select id="personalizeDownloadScale" class="settings-select" style="width: auto; padding-right: 28px;" title="选择渲染分辨率倍数">
                    <option value="1">1x 原始</option>
                    <option value="2">2x 高清</option>
                    <option value="4" selected>4x 超清</option>
                    <option value="6">6x 极清(注意卡顿)</option>
                    <option value="8">8x 极致(注意卡顿!)</option>
                  </select>
                  <button class="btn" id="personalizeDownloadBtn" style="min-width: 70px;">下载</button>
                </div>
              </div>
            </div>
          </div>
        </details>


        <h4 class="settings-subtitle host-only">在线设置</h4>

        <div class="settings-item host-only">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0" />
                <path d="M1.42 9a16 16 0 0 1 21.16 0" />
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
                <line x1="12" y1="20" x2="12.01" y2="20" />
              </svg>在线模式<span id="onlineStatus"
                style="font-size: 0.8rem; margin-left: 8px; font-weight: normal;"></span></div>
            <div class="settings-desc">开启后将生成链接可分享给他人同步查看抽取结果</div>
          </div>
          <div class="settings-action">
            <label class="switch">
              <input type="checkbox" id="onlineToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-item host-only">
          <div class="settings-info">
            <div class="settings-title"><svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
                <polyline points="10 17 15 12 10 7" />
                <line x1="15" y1="12" x2="3" y2="12" />
              </svg>加入房间</div>
            <div class="settings-desc">输入房间码加入已有房间</div>
          </div>
          <div class="settings-action" style="display: flex; gap: 8px;">
            <input type="text" id="joinRoomInput" class="room-code-input" placeholder="房间码" maxlength="6"
              inputmode="numeric" pattern="[0-9]*" style="width: 100px; text-align: center; cursor: text;">
            <button id="joinRoomBtn" class="btn primary" style="padding: 6px 12px;">加入</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 自定义 Alert 弹窗 -->
  <div id="alertModal" class="settings-modal hidden" style="z-index: 2001;">
    <div class="settings-backdrop"></div>
    <div class="settings-dialog" style="max-width: 400px; height: auto; min-height: auto;">
      <div class="settings-header">
        <h2 id="alertTitle">提示</h2>
        <button class="settings-close" id="alertCloseBtn">&times;</button>
      </div>

      <div class="settings-body" style="padding: 24px; text-align: center;">
        <div id="alertMessage" style="font-size: 1rem; margin-bottom: 24px; line-height: 1.5; word-wrap: break-word;">
        </div>
        <input type="text" id="alertInput" class="settings-select hidden" style="margin-bottom: 24px; width: 100%; text-align: left; padding: 10px;" autocomplete="off">
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button id="alertCancelBtn" class="btn hidden" style="flex: 1; justify-content: center;">取消</button>
          <button id="alertOkBtn" class="btn primary" style="flex: 1; justify-content: center;">确定</button>
        </div>
      </div>
    </div>
  </div>

  <div id="viewerLoader" class="viewer-loader hidden">
    <div class="loader-content">
      <div class="spinner-large"></div>
      <p id="loaderText">正在连接房间...</p>
      <button id="loaderExitBtn" class="btn primary hidden" style="margin-top: 20px;">退出</button>
    </div>
  </div>

  <!-- 角色标签弹窗 -->
  <div id="charTagsModal" class="modal hidden">
    <div class="modal-backdrop" data-chartags-close></div>
    <div class="modal-dialog" style="max-width: 1000px;">
      <div class="modal-header">
        <h3 style="display: flex; align-items: center; gap: 12px;">
          角色标签
          <div class="header-search-container" id="charTagsSearchContainer">
            <input type="text" id="charTagsSearchInput" class="search-input" placeholder="搜索角色/拼音..."
              autocomplete="off">
            <button id="charTagsSearchBtn" class="btn-search" title="搜索角色">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </button>
          </div>
        </h3>
        <button class="settings-close" data-chartags-close>×</button>
      </div>
      <div class="modal-body" style="padding: 16px; overflow-y: auto;">
        <div id="charTagsGrid" class="char-tags-grid"></div>
      </div>
    </div>
  </div>

  <script src="js/characters.js"></script>
  <script src="js/constants.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/avatar-settings.js"></script>
  <script src="js/personalize-settings.js"></script>
  <script src="js/online.js"></script>
  <script src="https://unpkg.com/pinyin-pro"></script>
  <script src="js/brain-teaser.js"></script>
  <script src="js/script.js"></script>
  <script src="js/context-menu.js"></script>

  <!-- 抽取历史弹窗 -->
  <div id="historyModal" class="modal hidden">
    <div class="modal-backdrop" data-history-close></div>
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>历史记录与统计信息</h3>
        <button class="settings-close" data-history-close>×</button>
      </div>
      <div class="tab-controls-wrapper">
        <div class="tab-controls">
          <button class="tab-btn active" data-tab="history">历史记录</button>
          <button class="tab-btn" data-tab="stats">统计信息</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="tabSlider">
          <div id="historyView" class="tab-view">
            <table class="history-table" id="historyTable">
              <thead>
                <tr>
                  <th>轮次</th>
                  <th>元素</th>
                  <th>国家</th>
                  <th>武器</th>
                  <th>体型</th>
                  <th>可用</th>
                </tr>
              </thead>
              <tbody id="historyTbody">
                <tr class="empty">
                  <td colspan="6">暂无记录</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="statsView" class="tab-view">
            <!-- 概览卡片区 -->
            <div class="stats-overview" id="statsOverview">
              <div class="overview-card">
                <div class="overview-value" id="statsTotalRounds">0</div>
                <div class="overview-label">总回合</div>
              </div>
              <div class="overview-card highlight-bad">
                <div class="overview-value" id="statsZeroAvailRounds">0</div>
                <div class="overview-label">零可用回合</div>
              </div>
              <div class="overview-card">
                <div class="overview-value" id="statsAvgAvail">—</div>
                <div class="overview-label">平均可用</div>
              </div>
              <div class="overview-card">
                <div class="overview-value" id="statsVariance">—</div>
                <div class="overview-label">标准差</div>
              </div>
            </div>

            <!-- 可用角色趋势 -->
            <div class="stats-section">
              <h4>可用角色数量趋势</h4>
              <div id="availChart" class="line-chart-container"></div>
            </div>

            <!-- 禁用标签统计 - 环形图 -->
            <div class="stats-section">
              <h4>禁用标签统计 (回合数)</h4>
              <div id="elemStats" class="donut-charts-container"></div>
            </div>

            <!-- 角色禁用统计 - 排行榜 -->
            <div class="stats-section">
              <h4>角色禁用统计 (回合数)</h4>
              <div id="charStats" class="char-heatmap"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>

</html>